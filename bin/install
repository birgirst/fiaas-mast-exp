#!/usr/bin/env bash

set -evuo pipefail

. /usr/local/share/bash/travis_dependencies.bash

install_kubectl() {
	echo "Installing kubectl"
	local url="https://storage.googleapis.com/kubernetes-release/release/v${K8S_VERSION}/bin/linux/amd64/kubectl"
	local checksum_url="https://storage.googleapis.com/kubernetes-release/release/v${K8S_VERSION}/bin/linux/amd64/kubectl.sha1"
	local install_dir="$(pwd)/kubectl/bin"

	mkdir -p "$install_dir"
	curl -Lo "$install_dir/kubectl" "$url"

	local checksum="$(curl -Lo - "$checksum_url")"
	echo "$checksum  $install_dir/kubectl" | shasum --algorithm 1 --check

	chmod +x "$install_dir/kubectl"

	mkdir ~/bin
	install "$install_dir/kubectl" ~/bin/kubectl
}

configure_kubectl() {
    kubectl config set-credentials schip-prod-user --token="${K8S_TOKEN}"
    kubectl config set-cluster schip-prod --insecure-skip-tls-verify=true --server="${K8S_HOST}"
    kubectl config set-context schip-prod-context --cluster=schip-prod --user=schip-prod-user --namespace="${K8S_NAMESPACE}"
    kubectl config use-context schip-prod-context
}

install_helm() {
    curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get > get_helm.sh
    chmod 700 get_helm.sh
    ./get_helm.sh --version "${HELM_VERSION}"
}

echo Upgrading pip and setuptools
pip install --upgrade pip setuptools # Make sure to always be on latest version of these

echo Uninstalling mock, pytest and py
pip uninstall -y mock pytest py # Get rid of old versions, so that we get the ones we want

sudo start-docker-daemon
install_kubectl
configure_kubectl
install_helm
export TILLER_NAMESPACE="${K8S_NAMESPACE}"
helm init
pip install -r requirements.txt
