#!/usr/bin/env bash

set -evuo pipefail

case "$INGRESS_HOST" in
'fiaas-mast-dev.ingress.prod01.cre-pro.schibsted.io')
    HEIMDALL_TOKEN=$HEIMDALL_TOKEN_PROD01_DEV
    ;;
'fiaas-mast.ingress.prod01.cre-pro.schibsted.io')
    HEIMDALL_TOKEN=$HEIMDALL_TOKEN_PROD01
    ;;
'fiaas-mast-dev.ingress.cre-pro.schibsted.io')
    HEIMDALL_TOKEN=$HEIMDALL_TOKEN_PROD02_DEV
    ;;
'fiaas-mast.ingress.cre-pro.schibsted.io')
    HEIMDALL_TOKEN=$HEIMDALL_TOKEN_PROD02
    ;;
*)
    echo "Heimdall token not found"; exit 1
    ;;
esac

ARGS=(
"--tiller-namespace=${K8S_NAMESPACE}"
'--install'
"--namespace=${K8S_NAMESPACE}"
'fiaas-mast'
'./helm/fiaas-mast'
'--set' "image.tag=${IMAGE_TAG}"
'--set' "secrets.token=${HEIMDALL_TOKEN}"
'--set' "secrets.artifactoryUser=${ARTIFACTORY_USER}"
'--set' "secrets.artifactoryPassword=${ARTIFACTORY_PWD}"
'--set' "ingress.host=${INGRESS_HOST}"
'--set' "annotations.fiaas/log-aggregation=sumologic"
# XXX: because of quoting and helm magic parsing of values containing '.', these values can not be cli args, but have to come from a file to actually work
'--values' './moniker_values.yml'
)

if [[ $K8S_NAMESPACE =~ "delivery-dev" ]]; then
    ARGS=(
        "${ARGS[@]}"
        '--set' 'besteffortQoS=true'
    )
fi


helm upgrade "${ARGS[@]}"
